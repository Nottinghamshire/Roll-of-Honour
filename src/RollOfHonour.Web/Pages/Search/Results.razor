@page "/Results"

@inject RollOfHonour.Core.Search.ISuperSearchService _searchService;
@inject IJSRuntime JSRuntime;
@using Ardalis.Result;
@using RollOfHonour.Core.Enums;
@using RollOfHonour.Core.Models;
@using RollOfHonour.Core.Models.Search;
@using RollOfHonour.Web.Pages.Shared.Components;

<section class="panel with-background bg-app">
    <div class="container is-fluid">
        <div class="breadcrumb-block with-margin-bottom">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li>
                        <a asp-page="/index" class="parent">Home
                            <span class="spacer" aria-hidden="true">
                                <i class="fa-light fa-chevron-right"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="/search" class="parent"> Search
                            <span class="spacer" aria-hidden="true">
                                <i class="fa-light fa-chevron-right"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="/search-results.html" aria-current="location" class="current">
                            Search Results for "@SearchString"
                        </a>
                    </li>
                </ol>
            </nav>
        </div>

        @if (HasResults)
        {
            <div class="columns is-multiline">
                <div id="results-jump-to" class="column is-full-tablet is-8-desktop is-8-widescreen is-8-fullhd">

                    <div class="text-block">
                        <h1>Search results for <span class="highlight">"@SearchString"</span></h1>
                        <p>The results for your search are listed below. You can make further adjustments to your search if
                            you need
                            to and the results will update for you.</p>
                    </div>

                    <div class="mobile-search-block">
                        <a href="#jumpto-filters" title="Change or filter these results"><i
                                class="fal fa-sort-size-down"></i> Change
                            or filter these search results?</a>
                    </div>
                    @if (PersonSearchResults.Any())
                    {
                        <PersonResults People=@PersonSearchResults />
                        <PagerComponent CurrentPage="@PageIndex" PageCount="@PersonSearchResults.TotalPages"
                    ChangePage="@ChangePage"></PagerComponent>
                    }
                    else if (MemorialSearchResults.Any())
                    {
                        <MemorialResults Memorials=@MemorialSearchResults />
                    }
                </div>
                <div class="column is-full-tablet is-4-desktop is-4-widescreen is-4-fullhd">
                    <aside class="sidebar" id="jumpto-filters">

                        <div class="search-filter-block">
                            <div class="form-toggle-block">
                                <span class="toggle-label">
                                    Specific War?
                                </span>
                                <ul>
                                    <li>
                                        <input type="radio" name="war" id="ww1" class="input-hidden ww1" />
                                        <label for="ww1" class="radio-label">
                                            <img src="/images/insignia-ww1-search.png" alt="World War 1"
                                                class="radio-image" />
                                            <span class="radio-text">World War 1</span>
                                        </label>
                                    </li>
                                    <li>
                                        <input type="radio" name="war" id="ww2" class="input-hidden ww2" />
                                        <label for="ww2" class="radio-label">
                                            <img src="/images/insignia-ww2-search.png" alt="World War 2"
                                                class="radio-image" />
                                            <span class="radio-text">World War 2</span>
                                        </label>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="search-filter-block">
                            <span class="filter-label">
                                Filter by regiment
                            </span>
                            <ul class="button-list"> 
                                @foreach (var regiment in _regimentFilters)
                                {
                                    <li>
                                        <div class="button_checkbox">
                                            <input type="checkbox" @onchange="(e => ToggleRegiment(regiment.RegimentId))" id="@regiment.Regiment">
                                            <label for="@regiment.Regiment">@regiment.Regiment</label>
                                        </div>
                                    </li>
                                }
                            </ul>
                        </div>
                        <div class="search-filter-block">
                            <div class="date-range-block">
                                <span class="filter-label">
                                    Filter between a specific period
                                </span>

                                <ul>
                                    <li>
                                        <div class="range-slider">
                                            <input class="range-slider__range" type="range" @bind=@_dateOfBirthFilter
                                                min="1850" max="2000" name="birth_date">
                                            <span class="range-slider__value">@_dateOfBirthFilter</span>
                                            <label for="birth_date">Date of Birth</label>
                                        </div>
                                    </li>

                                    <li>
                                        <div class="range-slider">
                                            <input class="range-slider__range" type="range" @bind=@_dateOfDeathFilter
                                                min="1850" max="2000" name="death_date">
                                            <span class="range-slider__value">@_dateOfDeathFilter</span>
                                            <label for="death_date">Date of Death</label>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="search-filter-block">
                            <div class="form-toggle-block">
                                <span class="toggle-label">
                                    Is this person Civilian or Military?
                                </span>
                                <ul>
                                    <li>
                                        <input type="radio" name="person-type" id="civilian" class="input-hidden" checked />
                                        <label for="civilian" class="radio-label">
                                            <img src="/images/insignia-civilian-search.png" alt="Civilian Records"
                                                class="radio-image" />
                                            <span class="radio-text">Civilian</span>
                                        </label>
                                    </li>
                                    <li>
                                        <input type="radio" name="person-type" id="military" class="input-hidden" />
                                        <label for="military" class="radio-label">
                                            <img src="/images/insignia-military-search.png" alt="Military Records"
                                                class="radio-image" />
                                            <span class="radio-text">Military</span>
                                        </label>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <button title="Look at this record" type="button" @onclick="FilterSearch" class="button primary"><i
                                class="fal fa-glasses" aria-hidden="true"></i> Filter Search
                        </button>

                        <a href="#jumpto-results" class="button primary mobile-results-button"
                            title="Go back to search results">
                            See your search results
                        </a>
                    </aside>
                </div>
            </div>
        }
    </div>
</section>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "s")]
    public string SearchString { get; set; } = String.Empty;

    public int PageIndex { get; set; } = 1;

    [Parameter]
    [SupplyParameterFromQuery(Name = "w")]
    public int SelectedWar { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "pt")]
    public int SelectedPersonType { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "qt")]
    public int SelectedQueryType { get; set; }

    private QueryType _selectedQueryType { get; set; } = QueryType.Person;
    private War _selectedWar { get; set; } = (int)War.WW1;
    private PersonType _selectedPersonType { get; set; } = PersonType.Military;
    private HashSet<int> _regimentIds { get; set; } = new();
    private int _dateOfDeathFilter { get; set; } = 1900;
    private int _dateOfBirthFilter { get; set; } = 1900;
    private List<RegimentFilter> _regimentFilters { get; set; } = new();
    public PaginatedList<Core.Models.Memorial> MemorialSearchResults = new();
    public PaginatedList<Core.Models.Person> PersonSearchResults = new();
    public bool HasResults => (MemorialSearchResults.Count() > 0 || PersonSearchResults.Count() > 0);

    protected override async Task OnInitializedAsync()
    {
        SetSearchParamsFromQuery();
        PersonSearchResults = new();
        MemorialSearchResults = new();

        if (_selectedQueryType == QueryType.Person)
        {
            await QueryPeople(false, PageIndex, 20);

            _regimentFilters = PersonSearchResults
            .Where(p => p.RegimentId != null)
            // Will never be null but coalesced to prevent warning
            .Select(p => new RegimentFilter(p.RegimentId ?? 0, p.Regiment))
            .DistinctBy(r => r.RegimentId)
            .ToList();
        }

        else if (_selectedQueryType == QueryType.Memorial)
        {
            var searchQuery = BuildMemorialQuery();

            Result<PaginatedList<Core.Models.Memorial>> results = await _searchService.MemorialSearch(searchQuery, PageIndex, 20);

            if (results.IsSuccess is not true)
            {
                // There were no results found so return
                return;
            }

            if (!results.Value.Any())
            {
                // There were no results found so return
                return;
            }

            MemorialSearchResults = results.Value;
        }
    }

    protected override void OnParametersSet()
    {
        SetSearchParamsFromQuery();
    }

    private async Task QueryPeople(bool stateChangeNeeded, int pageIndex, int pageSize)
    {
        if (_selectedQueryType == QueryType.Person)
        {
            var query = BuildPersonQuery();
            var filters = new Filters(_dateOfDeathFilter, _dateOfBirthFilter, _selectedPersonType, _regimentIds);
            Result<PaginatedList<Core.Models.Person>> results = await _searchService.PersonSearch(query, filters, pageIndex, 5);

            if (results.IsSuccess is not true)
            {
                return;
            }

            if (!results.Value.Any())
            {
                return;
            }


            PersonSearchResults = results.Value;
            if (stateChangeNeeded)
            {
                StateHasChanged();
            }
        }
    }

    private async Task FilterSearch()
    {
        await QueryPeople(true, 1, 20);
    }

    private void ToggleRegiment(int regimentId)
    {
       if (_regimentIds.Contains(regimentId))
       {
            _regimentIds.Remove(regimentId);
       }
       else
       {
            _regimentIds.Add(regimentId);
       }
    }

    private async Task ChangePage(int page)
    {
        PageIndex = page;
        await QueryPeople(true, PageIndex, 20);
        _ = await JSRuntime.InvokeAsync<bool>("scrollToElementId", "results-jump-to");
    }

    private PersonQuery BuildPersonQuery()
    {

        var searchQuery = new PersonQuery
            {
                SearchTerm = SearchString,
                SelectedWar = _selectedWar,
                PersonType = _selectedPersonType,
            };

        return searchQuery;
    }

    private MemorialQuery BuildMemorialQuery()
    {
        var searchQuery = new MemorialQuery
            {
                SearchTerm = SearchString ?? String.Empty
            };

        return searchQuery;
    }


    private void SetSearchParamsFromQuery()
    {
        _selectedQueryType = (QueryType)SelectedQueryType;
        _selectedPersonType = (PersonType)SelectedPersonType;
        _selectedWar = (War)SelectedWar;
    }
}